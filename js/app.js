/** DATA * */

/*
 * All lessons have a slot - these are the numbers 1 .. 40 which correspond to
 * the lesson throughout the week
 */
var table = [ {
	lessons : [ {
		day : "Monday",
		slot : 1,
		name : "Maths",
		time : "09:05",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Robson",
	}, {
		day : "Monday",
		slot : 2,
		name : "Geography",
		time : "09:45",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Powell",
	}, {
		day : "Monday",
		slot : 3,
		name : "English",
		time : "10:20",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Sadler",
	}, {
		day : "Monday",
		slot : 4,
		name : "Morning Break",
		time : "10:55",
		duration : 20,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Monday",
		slot : 5,
		name : "German",
		time : "11:15",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Hansen",
	}, {
		day : "Monday",
		slot : 6,
		name : "Physics",
		time : "11:50",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Wilks",
	}, {
		day : "Monday",
		slot : 7,
		name : "Physics",
		time : "12:30",
		duration : 60,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Wilks",
	}, {
		day : "Monday",
		slot : 8,
		name : "Lunch Break",
		time : "13:05",
		duration : 65,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Monday",
		slot : 9,
		name : "Spanish",
		time : "14:15",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Reece",
	}, {
		day : "Monday",
		slot : 10,
		name : "Spanish",
		time : "14:55",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Reece",

	} ]
}, {
	lessons : [ {
		day : "Tuesday",
		slot : 1,
		name : "Music",
		time : "09:05",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 2,
		name : "Music",
		time : "09:45",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 3,
		name : "Maths",
		time : "10:20",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Robson",
	}, {
		day : "Tuesday",
		slot : 4,
		name : "Morning Break",
		time : "10:55",
		duration : 20,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 5,
		name : "RE",
		time : "11:15",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 6,
		name : "German",
		time : "11:50",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Hansen",
	}, {
		day : "Tuesday",
		slot : 7,
		name : "German",
		time : "12:30",
		duration : 60,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Hansen",
	}, {
		day : "Tuesday",
		slot : 8,
		name : "Lunch Break",
		time : "13:05",
		duration : 65,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 9,
		name : "Games",
		time : "14:15",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Tuesday",
		slot : 10,
		name : "Games",
		time : "14:55",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",

	} ]
}, {
	lessons : [ {
		day : "Wednesday",
		slot : 1,
		name : "English",
		time : "09:05",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Sadler",
	}, {
		day : "Wednesday",
		slot : 2,
		name : "P.E.",
		time : "09:45",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 3,
		name : "P.E.",
		time : "10:20",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 4,
		name : "Morning Break",
		time : "10:55",
		duration : 20,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 5,
		name : "Maths",
		time : "11:15",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Robson",
	}, {
		day : "Wednesday",
		slot : 6,
		name : "Technology",
		time : "11:50",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 7,
		name : "Technology",
		time : "12:30",
		duration : 60,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 8,
		name : "Lunch Break",
		time : "13:05",
		duration : 65,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 9,
		name : "Biology",
		time : "14:15",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Wednesday",
		slot : 10,
		name : "Biology",
		time : "14:55",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",

	} ]
}, {
	lessons : [ {
		day : "Thursday",
		slot : 1,
		name : "English",
		time : "09:05",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Sadler",
	}, {
		day : "Thursday",
		slot : 2,
		name : "ICT",
		time : "09:45",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 3,
		name : "Spanish",
		time : "10:20",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Reece",
	}, {
		day : "Thursday",
		slot : 4,
		name : "Morning Break",
		time : "10:55",
		duration : 20,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 5,
		name : "History",
		time : "11:15",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 6,
		name : "Chemistry",
		time : "11:50",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 7,
		name : "Chemistry",
		time : "12:30",
		duration : 60,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 8,
		name : "Lunch Break",
		time : "13:05",
		duration : 65,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Thursday",
		slot : 9,
		name : "Geography",
		time : "14:15",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Powell",
	}, {
		day : "Thursday",
		slot : 10,
		name : "RE",
		time : "14:55",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",

	} ]
}, {
	lessons : [ {
		day : "Friday",
		slot : 1,
		name : "Geography",
		time : "09:05",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Powell",
	}, {
		day : "Friday",
		slot : 2,
		name : "Art",
		time : "09:45",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 3,
		name : "Art",
		time : "10:20",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 4,
		name : "Morning Break",
		time : "10:55",
		duration : 20,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 5,
		name : "English",
		time : "11:15",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mrs Sadler",
	}, {
		day : "Friday",
		slot : 6,
		name : "Roundabout",
		time : "11:50",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 7,
		name : "Roundabout",
		time : "12:30",
		duration : 60,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 8,
		name : "Lunch Break",
		time : "13:05",
		duration : 65,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 9,
		name : "History",
		time : "14:15",
		duration : 40,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "",
	}, {
		day : "Friday",
		slot : 10,
		name : "Maths",
		time : "14:55",
		duration : 35,
		homeworkdue : "",
		notes : "",
		done : true,
		teacher : "Mr Robson",

	} ]
}

];

//create our angular module and inject firebase
//angular.module('scheduleApp', ['firebase'])



var app = angular.module('scheduleApp', [ 'ui.bootstrap', 'ngCookies','ngAnimate' ,'firebase']);
app.controller(	'mainController', function($scope, $cookies, $log, $timeout, $firebaseArray) {

					$scope.render = true;

					// connect to firebase: https://timetable-joseph.firebaseio.com/
					var ref = new Firebase("https://timetable-joseph.firebaseio.com/timetable");

					// This assigns the timetable variable to the contents of the firebase array
					
					var syncObject = $firebaseArray(ref);
					

					$scope.timetable=syncObject;
					
//					ref.on("value", function(snapshot) {
//						  console.log(snapshot.val());
//						}, function (errorObject) {
//						  console.log("The read failed: " + errorObject.code);
//						});
//					
//					fb.$set($scope.timetable);
//					// sync as object
//					var syncObject = fb.$asObject();
//
//					// three way data binding
//				    syncObject.$bindTo($scope, 'vivid-fire-1308');
//
//					$scope.timetable = syncObject;

// ------------------------UNCOMMENT THIS TO USE Cookies ----------------------- //
//					var JStimetable = [];
//					// These getters and setters can be changed to use any
//					// datasource
//					$scope.getData = function() {
//
//						// reads the cookie lessonData. if it is null then it
//						// uses the predefined one above.
//						if ($cookies.getObject("lessonData0") != null) {
//							JStimetable.push(angular.fromJson($cookies.getObject("lessonData0")));
//							JStimetable.push(angular.fromJson($cookies.getObject("lessonData1")));
//							JStimetable.push(angular.fromJson($cookies.getObject("lessonData2")));
//							JStimetable.push(angular.fromJson($cookies.getObject("lessonData3")));
//							JStimetable.push(angular.fromJson($cookies.getObject("lessonData4")));
//
//						} else {
//							JStimetable = table;
//						}
//						;
//						$scope.timetable = JStimetable;
//					};
//
//					$scope.getData();

//					$scope.timetable = JStimetable;

// ----------------------------------------------------------------------------- //
					
					// Sets the data for a homework - writes it to a cookie
//					$scope.setData = function(day, lesson, date, notes, done) {
//						JStimetable = $scope.timetable;
//						
//						JStimetable[day].lessons[lesson].notes = notes;
//						JStimetable[day].lessons[lesson].homeworkdue = date;
//						JStimetable[day].lessons[lesson].done = done;
//
//						var lessonData = []; // to store JSON cookies
//						for ( var i = 0; i < JStimetable.length; i++) {
//
//							lessonData[i] = angular.toJson(JStimetable[i]);
//
//							$cookies.putObject('lessonData' + i, lessonData[i]);
//						}
//
//						$scope.timetable = JStimetable;
//					};

					// sets data for homework - writes data to firebase online
					// mongo style DB
					// found to be quite slow so using cookies
					$scope.setData = function(day, lesson, date, notes, done) {
//						 $log.log("day: "+day+" lesson:"+lesson+" Date: "+date+" Notes: "+notes);
						var noteRef = ref.child(day + "/lessons/" + lesson + "/notes/");
						noteRef.set(notes);
						var dueRef = ref.child(day + "/lessons/" + lesson + "/homeworkdue/");
						dueRef.set(date);
						var doneRef = ref.child(day + "/lessons/" + lesson + "/done/");
						doneRef.set(done);
					};

					$scope.isSet = function(val) {
						if (val != null) {
							return true;
						} else {
							return false;
						}
					};

					dateConv = function(d) {
						if (d != "" && d.toString().indexOf("-") > -1) {
							bit1 = d.split("T")[0];
							bit2 = d.split("T")[1];
							year = bit1.split("-")[0];
							month = bit1.split("-")[1];
							dd = bit1.split("-")[2];
							hour = bit2.split(":")[0];
							minute = bit2.split(":")[1];
							second = 0;
							return new Date(year, month - 1, dd, hour, minute,
									second);
						}

					};


					$scope.getBackgroundColor = function(day, lesson) {
//						$log.log("day = "+day+" lesson = "+lesson);
						var firstdate = new Date();
						var date1 = ref.child(day + "/lessons/" + lesson + "/homeworkdue/");
						
						date1.once("value", function(dueDate) {
							  if (dueDate != null)
								  $log.log("dueDate = "+dueDate.val());

							}, function (errorObject) {
							  $log.log("The read failed: " + errorObject.code);
							});
//						var d = $scope.timetable[day].lessons[lesson].homeworkdue;
//						if (d != null && d.toString() != "") {
//							if (d.toString().indexOf("-") > -1) {
//								// 2015-11-23T15:05:14.000Z
//								var seconddate = dateConv(d);
//							} else {
//								// Mon Nov 23 2015 16:53:44 GMT+0000 (GMT
//								// Standard Time
//								var seconddate = new Date(d);
//							}
//							var timeDiff = Math.abs(seconddate.getTime()
//									- firstdate.getTime());
//							if (timeDiff / (1000 * 3600 * 24) < 0.95) {
//								diffDays = 0;
//							} else {
//								var diffDays = Math.ceil(timeDiff
//										/ (1000 * 3600 * 24));
//							}
//							if (diffDays < 1) {
//								return '#ff0000';
//							} else if (diffDays < 2) {
//								return '#ff4d94';
//							} else if (diffDays < 3) {
//								return '#ff8040';
//							} else {
//								return '#99ff66';
//							}
//
//						} else {
//
//							return "#aad4ff";
//						}

					};

					$scope.dynamicPopover = {
						content : 'Hello, World!',
						templateUrl : 'myPopoverTemplate.html',
						title : 'Title'
					};

					$scope.status = {
						isopen : false
					};

					$scope.getNextRow = function(idx) {
						return table.lessons[idx];
					};

					$scope.toggleDropdown = function($event) {
						$event.preventDefault();
						$event.stopPropagation();
						$scope.status.isopen = !$scope.status.isopen;
					};

					
					// This sets dt as todays date on startup
					$scope.today = function() {
						$scope.dt = new Date();
					};

					// Need to change this so that it sets the date depending of
					// what is set in the data
					$scope.today();
					
					$scope.dtArray = new Array(10);
					
					getCorrectDate = function() {
						for ( var i = 0; i < $scope.timetable.length; i++) {
												
							$scope.dtArray[i]=new Array(5);
							for ( var j = 0; j < $scope.timetable[i].lessons.length; j++) {
								if($scope.timetable[i].lessons[j].homeworkdue == "") {
									$scope.dtArray[i][j] = new Date();
								} else {
									$scope.dtArray[i][j] = new Date($scope.timetable[i].lessons[j].homeworkdue);

									
								}
							}
						}
					};
					
					printArray = function() {
						for ( var i = 0; i < $scope.timetable.length; i++) {
							
							for ( var j = 0; j < $scope.timetable[i].lessons.length; j++) {

								$log.log("dtArray = ["+i+"]["+j+"] "+$scope.dtArray[i][j]);
							}
						}
					}
					
					getCorrectDate();
//					printArray();

					$scope.clear = function() {
						$scope.dt = null;
					};

					// Disable weekend selection
					$scope.disabled = function(date, mode) {
						return (mode === 'day' && (date.getDay() === 0 || date
								.getDay() === 6));
					};

					$scope.toggleMin = function() {
						$scope.minDate = $scope.minDate ? null : new Date();
					};
					$scope.toggleMin();
					$scope.maxDate = new Date(2020, 5, 22);

					$scope.open = function($event) {
						$scope.status.opened = true;
					};

					$scope.setDate = function(year, month, day) {
						$scope.dt = new Date(year, month, day);
					};

					$scope.dateOptions = {
						formatYear : 'yy',
						startingDay : 1
					};

					$scope.formats = [ 'dd-MM-yyyy', 'yyyy/MM/dd',
							'dd.MM.yyyy', 'shortDate' ];
					$scope.format = $scope.formats[0];

					$scope.status = {
						opened : false
					};

					var tomorrow = new Date();
					tomorrow.setDate(tomorrow.getDate() + 1);
					var afterTomorrow = new Date();
					afterTomorrow.setDate(tomorrow.getDate() + 2);
					$scope.events = [ {
						date : tomorrow,
						status : 'full'
					}, {
						date : afterTomorrow,
						status : 'partially'
					} ];

					$scope.getDayClass = function(date, mode) {
						if (mode === 'day') {
							var dayToCheck = new Date(date)
									.setHours(0, 0, 0, 0);

							for ( var i = 0; i < $scope.events.length; i++) {
								var currentDay = new Date($scope.events[i].date)
										.setHours(0, 0, 0, 0);

								if (dayToCheck === currentDay) {
									return $scope.events[i].status;
								}
							}
						}

						return '';
					};

					// Accordion
					$scope.status = {
						isFirstOpen : false,
						isFirstDisabled : false
					};
				});
